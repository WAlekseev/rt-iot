---
layout: docwithnav
title: Узлы преобразования
description: Документация к IoT платформе Ростелеком
---
Узлы преобразования используются для изменения полей входящих сообщений, таких как Отправитель, Тип сообщения, Полезная нагрузка и Метаданные.

* TOC
{:toc}


# Change originator


![image](/images/user-guide/rule-engine-2-0/nodes/transformation-change-originator.png)

Все входящие сообщения на платформе имеют поле Инициатор, которое обозначает объект, отправляющий сообщение. 
Это может быть Устройство, Актив, Клиент, Тенант и т.д.

Этот узел используется в тех случаях, когда отправленное сообщение должно быть обработано как сообщение от другой сущности.
Например, устройство отправляет телеметрию, и телеметрия должна быть скопирована в Объект более высокого уровня или в Клиент.
В этом случае администратор должен добавить этот узел перед узлом [**Save Timeseries**](/docs/user-guide/rule-engine-2-0/action-nodes/#save-timeseries-node).

Инициатор может быть изменен на:

- Клиента инициатора
- Тенанта инициатора
- Связанную сущность, которая определяется запросом связей

В настройке Запроса связей администратор может выбрать требуемое **направление** или **уровень глубины отношений**.
Также **фильтры отношений** могут быть настроены по требуемым типам отношений и сущностей.

![image](/images/user-guide/rule-engine-2-0/nodes/transformation-change-originator-config.png)

Если найдено несколько связанных сущностей, то в качестве нового инициатора используется **только первая сущность**, остальные отбразываются.

Цепочка **Failure**  используется, если не было найдено ни одной связанной сущности / клиента / тенанта, в противном случае - цепочка **Success**.

В исходящее сообщение передастся новый идентификатор отправителя.

<br/>

# Узел преобразования скрипта


![image](/images/user-guide/rule-engine-2-0/nodes/transformation-script.png)

Изменяет полезную нагрузку сообщения, метаданные или тип сообщения с помощью настроенной JavaScript- функции.

Функция получает 3 входных параметра:

- <code>msg</code> - полезная нагрузка сообщения.
- <code>metadata</code> - метаданные сообщения.
- <code>msgType</code> - тип сообщения.

Скрипт должен вернуть структуру:
{% highlight java %}
{   
    msg: new payload,
    metadata: new metadata,
    msgType: new msgType 
}
{% endhighlight %}

![image](/images/user-guide/rule-engine-2-0/nodes/transformation-script-config.png)

Все поля в полученном объекте являются необязательными и будут взяты из исходного сообщения, если они не указаны.

Исходящее сообщение с этого узла будет новым сообщением, созданным с помощью настроенной функции JavaScript.

Функция преобразования JavaScript может быть проверена с помощью [Тестовой JavaScript-функции](/docs/user-guide/rule-engine-2-0/overview/#test-javascript-functions).

<br/>
**Пример**

Узел получает сообщение с **полезной нагрузкой**:
{% highlight java %}
{
    "temperature": 22.4,
    "humidity": 78
}
{% endhighlight %}

Исходные **метаданные**:
{% highlight java %}
{ "sensorType" : "temperature" }
{% endhighlight %}


Исходный **тип сообщения** - POST_TELEMETRY_REQUEST
<br/>

Необходимо выполнить следующие изменения:

- изменить тип сообщения на 'CUSTOM_UPDATE' 
- добавить дополнительный атрибут **_version_** в полезную нагрызку с версией **_v1.1_**
- изменить в метаданных значение атрибута _**sensorType**_ на **_roomTemp_**

Следующая функция преобразования выполнит все необходимые изменения:
{% highlight java %}
var newType = "CUSTOM_UPDATE";
msg.version = "v1.1";
metadata.sensorType = "roomTemp"
return {msg: msg, metadata: metadata, msgType: newType};
{% endhighlight %}

В следующих руководствах вы можете ознакомиться с примером использования данного узла:

- [Преобразование входящей телеметрии](/docs/user-guide/rule-engine-2-0/tutorials/transform-incoming-telemetry/)
- [Ответ на RPC-вызовы](/docs/user-guide/rule-engine-2-0/tutorials/rpc-reply-tutorial.md#add-transform-script-node)

# Узел To Email

![image](/images/user-guide/rule-engine-2-0/nodes/transformation-to-email.png)

Преобразует сообщение в письмо по электронной почте, заполняя поля письма значениями, полученными из метаданных сообщения. 
Установите тип исходящего сообщения ‘SEND_EMAIL’, он может быть принят позже узлом  [**Send Email**](/docs/user-guide/rule-engine-2-0/external-nodes/#send-email-node).
Все поля электронной почты можно настроить так, чтобы использовались значения из метаданных.
  
![image](/images/user-guide/rule-engine-2-0/nodes/transformation-to-email-config.png)

Например, входящее сообщение имеет поле **deviceName** в метаданных, а тело электронной почты должно содержать его значение.

В таком случае значение данного поля может указываться в формате <code>${deviceName}</code>. Пример:

 ```
 Device ${deviceName} has high temperature
 ```
 
<br/>

Также этот узел может подготовить вложения для электронного письма, если метаданные входящего сообщения содержат поле **вложений** со ссылкой на файлы, хранящиеся в базе данных.

<br/>

В следующем руководстве вы можете ознакомиться с примером использования данного узла

- [Send Email](/docs/user-guide/rule-engine-2-0/tutorials/send-email/)
