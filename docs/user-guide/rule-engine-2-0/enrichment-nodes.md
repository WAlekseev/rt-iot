---
layout: docwithnav
title: Узлы обогащения
description: Документация к IoT платформе Ростелеком
---

Узлы данного типа используются для обновления метаданных входящих сообщений.

* TOC
{:toc}

##### Customer attributes

![image](/images/user-guide/rule-engine-2-0/nodes/enrichment-customer-attributes.png)

Узел находит пользователя, который относится к отправителю сообщения, и добавляет пользовательские атрибуты или последнее телеметрическое значение в метаданные сообщения.

Администратор может настроить сопоставление между исходным названием атрибута и названием атрибута метаданных.

В настройках узла есть флажок **Последняя телеметрия**. Если флажок установлен, узел будет получать последнюю телеметрию для настроенных ключей. В противном случае узел будет получать атрибуты области действия сервера.

![image](/images/user-guide/rule-engine-2-0/nodes/enrichment-customer-attributes-config.png)

Метаданные исходящего сообщения будут содержать настроенные атрибуты, если они есть. Чтобы получить доступ к извлеченным атрибутам в других узлах, вы можете использовать шаблон '<code>metadata.temperature</code>'

Допускаются следующие типы отправителей сообщений: **Клиент**, **Пользователь**, **Актив**, **Устройство**.
 
Если обнаружен неподдерживаемый тип отправителя, возникнет ошибка.

Если у отправителя нет назначенной сущности Клиент, используется цепочка **Failure**, в противном случае - цепочка **Success**.

В следующем руководстве вы можете увидеть пример, где используется этот узел:

- [Отправка электронного письма](/docs/user-guide/rule-engine-2-0/tutorials/send-email/)

##### Device attributes

![image](/images/user-guide/rule-engine-2-0/nodes/enrichment-device-attributes.png)

С помощью настроенного запроса узел находит устройство, которое связано с сущностью отправителя сообщения, и добавляет атрибуты (клиент\общий доступ\область действия сервера) и последнее значение телеметрии в метаданные сообщения.

Атрибуты добавляются с префиксом области действия:

- Общий атрибут -> <code>shared_</code>
- Клиентский атрибут -> <code>cs_</code>
- Серверный атрибут -> <code>ss_</code>
- Телеметрия -> без префикса

Например, общий атрибут 'version' будет добавлен в метаданные с именем «shared_version». В атрибутах клиента будет использоваться префикс ‘cs_'.
Атрибуты сервера используют префикс ‘ss_’. Последнее значение телеметрии будет добавлено в метаданные сообщения в том формате, в котором было передано, без префикса.

В настройке "Запрос отношений устройств" администратор может выбрать необходимое **направление** и **уровень глубины связи**. 
Также тип связи может быть настроен для необходимых **типов устройств**.

![image](/images/user-guide/rule-engine-2-0/nodes/enrichment-device-attributes-config.png)

Если найдено несколько связанных сущностей, то для дополнения атрибутов используется **только первая сущность**, остальные - не используются.

Цепочка**Failure** используется, если не было найдено ни одной связанной сущности, в противном случае - цепочка **Success**.

Если атрибут или телеметрия не были найдены, они не добавляются в метаданные сообщения, и оно по-прежнему направляется по цепочке **Success**.

Метаданные исходящего сообщения будут содержать настроенные атрибуты, если они существуют.

Для доступа к извлеченным атрибутам в других узлах вы можете использовать шаблон '<code>metadata.temperature</code>'

**Примечание**:  узел правил может включать/отключать генерирование отчета об **ошибке**, если хотя бы один выбранный ключ не существует в исходящем сообщении.

![image](/images/user-guide/rule-engine-2-0/nodes/enrichment-orignator-and-device-attributes-tell-failure.png)

##### Атрибуты отправителя

![image](/images/user-guide/rule-engine-2-0/nodes/enrichment-originator-attributes.png)

Вы можете добавить атрибуты отправителя сообщения (клиентская\общая\серверная область действия) и последнюю телеметрию в метаданные сообщения.

Атрибуты добавляются с префиксом области действия:

- Общий атрибут -> <code>shared_</code>
- Клиентский атрибут -> <code>cs_</code>
- Серверный атрибут -> <code>ss_</code>
- Телеметрия -> без префикса

Например, общий атрибут 'version' будет добавлен в метаданные с названием «shared_version». Атрибуты клиента будут использовать префикс ‘cs_'. Серверные атрибуты используют префикс ‘ss_’. Последнее значение телеметрии добавляется в метаданные сообщения в том формате, в котором приходит, без префикса.

![image](/images/user-guide/rule-engine-2-0/nodes/enrichment-originator-attributes-config.png)

Метаданные исходящего сообщения будут содержать настроенные атрибуты, если они есть.

Для доступа к извлеченным атрибутам в других узлах вы можете использовать шаблон '<code>metadata.cs_temperature</code>'

**Примечание**:  узел правил может включать/отключать генерирование отчета об **ошибке**, если хотя бы один выбранный ключ не существует в исходящем сообщении.

![image](/images/user-guide/rule-engine-2-0/nodes/enrichment-orignator-and-device-attributes-tell-failure.png)

В следующих руководствах вы можете увидеть пример, где используется этот узел:

- [Преобразование телеметрии с использованием предыдущих записей](/docs/user-guide/rule-engine-2-0/tutorials/transform-telemetry-using-previous-record/)
- [Отправка электронного письма](/docs/user-guide/rule-engine-2-0/tutorials/send-email/)

##### Поля отправителя

![image](/images/user-guide/rule-engine-2-0/nodes/enrichment-originator-fields.png)

Узел получает значения полей сущности отправителя и добавляет их в метаданные сообщения. Администратор может настроить сопоставление между именем поля и именем атрибута метаданных. Если указанное поле не передается в сущности отправителя сообщения, оно будет проигнорировано.

![image](/images/user-guide/rule-engine-2-0/nodes/enrichment-originator-fields-config.png)

Доступны следующие типы отправителей сообщений: **Тенант**, **Клиент**, **Пользователь**, **Актив**, **Устройство**, **Сигнал тревоги**, **Цепочка правил**.

Цепочка **Failure** используется, если найден неподдерживаемый тип отправителя, в противном случае - цепочка **Success**.

Если значение поля не было найдено, оно не добавляется в метаданные сообщения, и сообщение дальше направляется по цепочке **Success**.

Метаданные исходящего сообщения будут содержать настроенные атрибуты, если они есть в сообщении. 

Для доступа к извлеченным атрибутам в других узлах вы можете использовать шаблон '<code>metadata.devType</code>'

##### Связанные атрибуты

![image](/images/user-guide/rule-engine-2-0/nodes/enrichment-related-attributes.png)

Узел находит связанную сущность отправителя сообщения с помощью настроенного запроса и добавляет атрибуты или последнее значение телеметрии в метаданные сообщения.
 
Администратор может настроить сопоставление между исходным именем атрибута и именем атрибута метаданных.

В настройке "Запрос связей" администратор может выбрать необходимое **направление** и **уровень глубины связей**.
Также вы можете настроить **фильтры связей** по требуемым типам отношений и сущностей.

В настройке узла есть флаг **Последняя телеметрия**. Если этот флажок установлен, узел будет получать последнюю телеметрию для настроенных ключей. В противном случае узел будет извлекать атрибуты области действия сервера.

![image](/images/user-guide/rule-engine-2-0/nodes/enrichment-related-attributes-config.png)

Если найдено несколько связанных сущностей, то для дополнения атрибутов используется **только первая сущность**, остальные - не учитываются.

Если не найдена связанная сущность, используется цепочка **Failure**, в противном случае - цепочка **Success**.

Метаданные исходящего сообщения будут содержать настроенные атрибуты, если они есть.

Для доступа к извлеченным атрибутам в других узлах вы можете использовать шаблон '<code>metadata.tempo</code>'

В следующем руководстве вы можете увидеть пример, где используется этот узел:

- [Ответ на RPC-вызовы](/docs/user-guide/rule-engine-2-0/tutorials/rpc-reply-tutorial/#add-related-attributes-node)

##### Атрибуты тенанта

<table  style="width:12%">

![image](/images/user-guide/rule-engine-2-0/nodes/enrichment-tenant-attributes.png)

Узел находит тенанта, который связан с отправителем сообщения, и добавляет тенанту в метаданные атрибуты или значения последних телеметрических данных.

Администратор может настроить сопоставление между исходным именем атрибута и именем атрибута метаданных.

В настройках узла есть флажок **Последняя телеметрия**. Если этот флажок установлен, узел будет получать последнюю телеметрию для настроенных ключей. В противном случае узел будет получать атрибуты области действия сервера.

![image](/images/user-guide/rule-engine-2-0/nodes/enrichment-tenant-attributes-config.png)

Метаданные исходящего сообщения будут содержать настроенные атрибуты, если они есть. Чтобы получить доступ к извлеченным атрибутам в других узлах, вы можете использовать шаблон '<code>metadata.tempo</code>'

Доступны следующие типы отправителей сообщений: **Тенант**, **Клиент**, **Пользователь**, **Актив**, **Устройство**, **Сигнал тревоги**, **Цепочка правил**.

Если обнаружен неподдерживаемый тип отправителя, возникнет ошибка. 

Если у отправителя сообщения нет назначенного тенанта, флоу будет направлено по цепочке **Failure**. В ином случае – по цепочке **Success**.

##### Телеметрия отправителя

![image](/images/user-guide/rule-engine-2-0/nodes/enrichment-originator-telemetry.png)

Добавляет в метаданные сообщения те значения телеметрии отправителя, которые находятся в рамках определенного временного диапазона, заданного в настройках узла.

![image](/images/user-guide/rule-engine-2-0/nodes/enrichment-originator-telemetry-config.png)

Телеметрические значения добавляются в метаданные сообщений без префикса.

У узла правил есть три режима выборки:

 - Первый: извлекает из базы данных ту телеметрию, которая находится ближе всего к началу временного диапазона

 - Последний: извлекает из базы данных ту телеметрию, которая находится ближе всего к концу временного диапазона

 - Все: извлекает из базы данных всю телеметрию, которая находится в указанном временном диапазоне.
 
![image](/images/user-guide/rule-engine-2-0/nodes/enrichment-originator-telemetry-fetch-mode.png)

Если выбран Первый или Последний режим, метаданные исходящего сообщения будут содержать элементы JSON (ключ/значение)

В противном случае, если выбран режим Все, телеметрия будет получена в виде массива.

<table  style="width: 60%">
   <thead>
     <tr>
     <td><strong><em>Примечание:</em></strong></td>
     </tr>
   </thead>
   <tbody>
     <tr>
    <td>
    <p>Узел правил может извлечь максимум 1000 записей</p>
    </td>
     </tr>
   </tbody>
</table>

Этот массив будет содержать JSON-объекты с временной меткой и значением.

<table  style="width: 60%">
   <thead>
     <tr>
     <td><strong><em>Примечание:</em></strong></td>
     </tr>
   </thead>
   <tbody>
     <tr>
    <td>
    <p>Конец интервала всегда должен быть меньше начала интервала.</p>
    </td>
     </tr>
   </tbody>
</table>

Если установлен флажок  **Использовать шаблоны интервалов метаданных**, узел правил будет использовать шаблоны начала и конца интервала из метаданных.

Единицы измерения паттернов измеряются в миллисекундах, точка отсчета с начала с эпохи UNIX (1 января 1970 года 00:00:00 UTC)

![image](/images/user-guide/rule-engine-2-0/nodes/enrichment-originator-telemetry-patterns.png)

 - Если какой-либо шаблон будет отсутствовать в метаданных сообщения, исходящее сообщение будет направлено по цепочке **failure**.
 
 - Кроме того, если какой-либо шаблон будет содержать недопустимый тип данных, исходящее сообщение также будет направлено по цепочке **failure**.

В метаданных исходящего сообщения будут передаваться настроенные поля телеметрии, если они есть и входят в рамки выбранного диапазона.

Если атрибут или телеметрия не были найдены, они не добавятся в метаданные сообщения, и сообщение дальше отправится по цепочке **Success**.
 
Для доступа к извлеченной телеметрии в других узлах вы можете использовать шаблон: <code>JSON.parse(metadata.temperature)</code>

**Примечание:** начиная с версии платформы 2.3, узел правил может применить тот или иной порядок выборки телеметрии при включенном режиме выборки Все.

![image](/images/user-guide/rule-engine-2-0/nodes/enrichment-originator-telemetry-order-by.png)

В следующем руководстве вы можете увидеть пример, где используется этот узел:

- [Расчет дельты телеметрии](/docs/user-guide/rule-engine-2-0/tutorials/telemetry-delta-validation/)

##### Детали тенанта

![image](/images/user-guide/rule-engine-2-0/nodes/enrichment-tenant-details.png)

Узел правил добавляет поля из сведений о тенанте в тело или метаданные сообщения.

В настройках узла есть флажок **Добавить выбранные сведения в метаданные сообщения**. Если этот флажок установлен, то существующие поля будут добавлены в метаданные сообщения вместо данных сообщения.

![image](/images/user-guide/rule-engine-2-0/nodes/enrichment-tenant-details-config.png)

Выбранные сведения добавляются в метаданные с префиксом: **tenant_**. Исходящее сообщение будет содержать заданные в настройках сведения, если они существуют.

Для доступа к извлеченным сведениям в других узлах можно использовать один из следующих шаблонов:

- <code>metadata.tenant_address</code>

- <code>msg.tenant_address</code>

Цепочка **Failure** используется, если у отправителя нет назначенной сущности тенанта, в противном случае - цепочка **Success**.

##### Детали клиента

![image](/images/user-guide/rule-engine-2-0/nodes/enrichment-customer-details.png)

Узел правил добавляет поля из сведений о клиенте в тело или метаданные сообщения.


В настройках узла есть флажок **Добавить выбранные сведения в метаданные сообщения**. Если этот флажок установлен, то существующие поля будут добавлены в метаданные сообщения вместо данных сообщения.

![image](/images/user-guide/rule-engine-2-0/nodes/enrichment-customer-details-config.png)

Выбранные сведения добавляются в метаданные с префиксом: **customer_**. Исходящее сообщение будет содержать настроенные сведения, если они существуют.

Для доступа к извлеченным сведениям в других узлах можно использовать один из следующих шаблонов:

- <code>metadata.customer_email</code>

- <code>msg.customer_email</code>

Разрешены следующие типы отправителей сообщений: **Объект**, **Устройство**, **Визуально представление сущности**.
  
Если обнаружен неподдерживаемый тип отправителя, возникнет ошибка.
 
Если у отправителя нет назначенной сущности Клиент, используется цепочка **Failure**, в ином случае - цепочка **Success**.
 
