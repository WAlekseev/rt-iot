---
layout: docwithnav
title: Внешние узлы
description: Внешние узлы
---

Внешние узлы используются для взаимодействия с внешними системами.

* TOC
{:toc}


# Узлы AWS SNS

![image](/images/user-guide/rule-engine-2-0/nodes/external-aws-sns.png)

Узел публикует сообщения в AWS SNS (Amazon Simple Notification Service).

Настройка:

![image](/images/user-guide/rule-engine-2-0/nodes/external-aws-sns-config.png)

- **Topic ARN pattern** - может быть задано прямое имя темы для публикации сообщения или может быть использован шаблон, который будет разрешен для реального имени ARN-темы с помощью метаданных сообщения.. 
- **AWS Access Key ID** и **AWS Secret Access Key** это учетные данные пользователя AWS IAM с программным доступом. Более подробную информацию о ключах доступа AWS можно найти [здесь](http://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_access-keys.html). 
- **AWS Region** должен соответствовать тому, в котором создается тема/темы SNS. Актуальный список регионов находится [здесь ](http://docs.aws.amazon.com/general/latest/gr/rande.html).

В следующем примере имя темы зависит от типа устройства, и есть сообщение, содержащее поле deviceType в метаданных:

{% highlight javascript %}
{
    deviceType: controller
}
{% endhighlight %}

Для публикации сообщения в теме контроллера мы установим этот шаблон в качестве шаблона ARN-темы:

{% highlight bash %}
arn:aws:sns:us-east-1:123456789012:${deviceType}
{% endhighlight %}

Во время выполнения шаблон будет разрешен в <code>arn:aws:sns:us-east-1:123456789012:controller</code>

**Published payload** - узел опубликует полную полезную нагрузку сообщения в SNS. При необходимости цепочка правил может быть настроена для использования цепочки узлов преобразования для отправки корректных данных с полезной нагрузкой в SNS.

**Outbound message** с этого узла будет содержать ответ messageId и requestId в метаданных сообщения. Исходная полезная нагрузка сообщения, тип и отправитель не будут изменены.


# Kafka Node

![image](/images/user-guide/rule-engine-2-0/nodes/external-kafka.png)

Узел Kafka отправляет сообщения брокерам Kafka. Затем ожидает сообщения любого типа и высылает запись через поставщика Kafka на сервер Kafka.

Настройки:

![image](/images/user-guide/rule-engine-2-0/nodes/external-kafka-config.png)

- **Topic pattern** - cможет быть статической строкой или шаблоном, который разрешается с помощью свойств метаданных сообщения. Например, <code>${deviceType}</code>
- **bootstrap servers** - список брокеров kafka, перечисленных через запятую.
- **Automatically retry times** - nколичество попыток повторной отправки сообщения при сбое соединения.
- **Produces batch size** - размер пакета в байтах для группировки сообщений с одним и тем же разделом.
- **Time to buffer locally** - максимальная длительность показа окна локальной буферизации в миллисекундах.
- **Client buffer max size** - в байтах для отправки сообщений.
- **Number of acknowledgments** - количество подтверждений, которые узел должен получить, прежде чем считать запрос завершенным.
- **Key serializer** - по умолчанию org.apache.kafka.common.serialization.StringSerializer 
- **Value serializer** - по умолчанию org.apache.kafka.common.serialization.StringSerializer 
- **Other properties** - любые другие дополнительные свойства, которые могут быть предоставлены для подключения брокера kafka.

**Published body** - узел вышлет полный объем данных по полезной нагрузке сообщения на тему Kafka. При необходимости цепочка правил может быть настроена так, чтобы использовалась цепочка узлов преобразования для отправки корректной полезной нагрузки в Kafka.

**Outbound message** исходящее сообщение с этого узла будет содержать offset ответа, раздел и свойства темы в метаданных сообщения. Исходная полезная нагрузка сообщения, тип и отправитель не будут изменены.

**Примечание** - Если вы хотите использовать [Confluent cloud](https://confluent.cloud) в качестве kafka брокера, вам следует добаыить следующие свойства: 

<table>
    <tr>
        <th>Key</th>
        <th>Value</th>
    </tr>
    <tr>
        <td>ssl.endpoint.identification.algorithm</td>
        <td>https</td>
    </tr>
    <tr>
        <td>sasl.mechanism</td>
        <td>PLAIN</td>
    </tr>
    <tr>
        <td>sasl.jaas.config</td>
        <td>org.apache.kafka.common.security.plain.PlainLoginModule required username="CLUSTER_API_KEY" password="CLUSTER_API_SECRET";</td>
    </tr>
    <tr>
        <td>security.protocol</td>
        <td>SASL_SSL</td>
    </tr>
</table>
- **CLUSTER_API_KEY** - your access key from Cluster settings.
- **CLUSTER_API_SECRET** - your access secret from Cluster settings.

<br/>

# MQTT Узел



![image](/images/user-guide/rule-engine-2-0/nodes/external-mqtt.png)

Публикует данные полезной нагрузки входящего сообщения в теме настроенного брокера MQTT с QoS AT_LEAST_ONCE. 

Настройки:

![image](/images/user-guide/rule-engine-2-0/nodes/external-mqtt-config.png)

- **Topic pattern** - может быть статической строкой или шаблоном, который регулируется с помощью свойств метаданных сообщения. Например, <code>${deviceType}</code>.
- **Host** - MQTT broker хост.
- **Port** - MQTT broker порт.
- **Connection timeout** - Время ожидания соединения в секундах для подключения к брокеру MQTT.
- **Client ID** - Необязательный идентификатор клиента, используемый для подключения к брокеру MQTT. Если он не установлен, то будет использоваться созданный по умолчанию идентификатор клиента.
- **SSL Enable/Disable** -  включение/выключение защищенной связи.  
- **Credentials** - Учетные данные подключения MQTT. Может быть *Anonymous*, *Basic* or *PEM*.

Для внешнего брокера MQTT поддерживаются разные форматы аутентификации::

- Anonymous - нет аутентификации
- Basic - для аутентификации используются пары логин/пароль
- PEM - для аутентификации используются PEM-сертификаты n

Если выбран тип учетных данных **PEM**, то будут доступны следующие настройки:

- CA certificate file
- Certificate file
- Private key file
- Private key password

<br/>

**Published body** - узел вышлет полный объем данных по полезной нагрузке сообщения на тему Kafka. При необходимости цепочка правил может быть настроена так, чтобы использовалась цепочка узлов преобразования для отправки корректной полезной нагрузки брокеру MQTT.

В случае успешной публикации сообщения исходное сообщение будет передано следующим узлам по цепочке *Success**, в противном случае используется цепочка **Failure**.

<br/>

# RabbitMQ Node

![image](/images/user-guide/rule-engine-2-0/nodes/external-rabbitmq.png)

Публикует полезную нагрузку входящего сообщения в RabbitMQ.

Настройки

![image](/images/user-guide/rule-engine-2-0/nodes/external-rabbitmq-config.png)

- **Exchange name pattern** - exchange, на который публикуется сообщение. Это может быть статическая строка или шаблон, регулируемый с помощью свойств метаданных сообщения. Например <code>${deviceType}</code> .
- **Routing key pattern** - ключ маршрутизации. Это может быть статическая строка или шаблон, регулируемый с помощью свойств метаданных сообщения. Например, <code>${deviceType}</code> .
- **Message properties** - oнеобязательные заголовки маршрутизации. Поддерживаемые заголовки:  *BASIC*, *TEXT_PLAIN*, *MINIMAL_BASIC*, *MINIMAL_PERSISTENT_BASIC*, *PERSISTENT_BASIC*, *PERSISTENT_TEXT_PLAIN*
- **Host** - хост по умолчанию, используемый для подключения
- **Port** - порт по умолчанию, используемый для подключения
- **Virtual host** - виртуальный хост, используемый при подключении к брокеру
- **Username** - имя пользователя AMQP, используемое при подключении к брокеру
- **Password** - пароль AMQP, используемый при подключении к брокеру
- **Automatic recovery** - включает или выключает автоматическое восстановление соединения
- **Connection timeout** - время ожидания установления TCP-соединения, измеряется в миллисекундах (от нуля для бесконечности)
- **Handshake timeout** - тайм-аут установки связи протокола AMQP0-9-1, измеряется в миллисекундах
- **Client properties** - дополнительные свойства, которые отправляются на сервер при установке соединения

**Published body** - - узел вышлет полный объем данных по полезной нагрузке сообщения в RabbitMQ. При необходимости цепочка правил может быть настроена так, чтобы использовалась цепочка узлов преобразования для отправки корректной полезной нагрузки.

В случае успешной публикации сообщения исходное сообщение будет передано следующим узлам по цепочке **Success**, в противном случае используется цепочка **Failure**.

<br/>

# Узел вызова REST API

![image](/images/user-guide/rule-engine-2-0/nodes/external-rest-api-call.png)

Выполняет REST API-вызовы к внешнему REST-серверу.

Настройки:

![image](/images/user-guide/rule-engine-2-0/nodes/external-rest-api-call-config.png)

- **Endpoint URL pattern** - Cможет быть статической строкой или шаблоном, который регулируется с помощью свойств метаданных сообщения. Например, <code>${deviceType}</code>
- **Request method** - метод запроса - *GET*, *POST*, *PUT*, *DELETE*
- **Headers** - заголовки запроса или значение, могут быть статической строкой или шаблоном, который регулируется с помощью свойств метаданных сообщения..

**Endpoint URL**

Может быть статической строкой или шаблоном. Для регулирования шаблонов используются только метаданные сообщений. Таким образом, имена свойств, используемые в шаблонах, должны существовать в метаданных сообщения, иначе в URL-адрес будет добавлен необработанный шаблон.

Например, если полезная нагрузка сообщения содержит свойство **deviceType** со значением **container**, то следующий шаблон: 

<code>http://localhost/api/${deviceType}/update</code> 

преобразуется в 

<code>http://localhost/api/container/update</code>   

**Заголовки**

Можно настроить коллекцию пар имя/значение для заголовков. Они будут добавлены в REST-запрос. Шаблон должен использоваться как для настроенного имени заголовка, так и для настроенного значения заголовка. Например, <code>${deviceType}</code>. }. Для настроек шаблонов используются только метаданные сообщений. Таким образом, имена свойств, используемые в шаблоне, должны существовать в метаданных сообщения, иначе в заголовок будет добавлен необработанный шаблон.

**Request body** - узел отправит полную полезную нагрузку сообщения в настроенную конечную точку REST-запроса. При необходимости цепочка правил может быть настроена так, чтобы использовалась цепочка узлов преобразования для отправки корректной полезной нагрузки.

**Outbound message** исходящее с этого узла сообщение будет содержать в метаданных **status**, **statusCode**, **statusReason** и заголовки ответа **headers** Полезная нагрузка исходящего сообщения будет такой же, как и тело ответа. Исходный тип сообщения и отправитель не будут изменены.
В случае успешной публикации сообщения исходное сообщение будет передано следующим узлам по цепочке **Success**, в противном случае используется цепочка **Failure**.


<br/>

# Узел отправки Email


![image](/images/user-guide/rule-engine-2-0/nodes/external-send-email.png)

Узел отправляет входящее сообщение с помощью настроенного почтового сервера. Этот узел работает только с сообщениями, которые были созданы с помощью узла преобразования сообщения в  
[**Email**](/docs/user-guide/rule-engine-2-0/transformation-nodes/#to-email-node). Соедините этот узел с узлом **To Email** по цепочке **Success**.

Настройки:

![image](/images/user-guide/rule-engine-2-0/nodes/external-send-email-config.png)

- **Use system SMTP settings** - использовать системные настройки SMTP - если на системном уровне настроен включенный почтовый сервер по умолчанию
- **Protocol** -  *SMTP* или *SMTPS*
- **SMTP host** - Mail Server host
- **SMTP port** - Mail Server port
- **Timeout ms** - таймаут в миллисекундах
- **Enable TLS** - если значение true, то позволяет использовать команду STARTTLS (если она поддерживается сервером)
- **Username** - пользователь учетной записи на почтовом хостинге, если он настроен
- **Password** - пароль учетной записи на почтовом хостинге, если он настроен

Этот узел может работать с почтовым сервером, настроенным на системном уровне. Более подробная информация о том, как настроить SMTP [здесь](/docs/user-guide/ui/mail-settings/)

IЕсли для этого узла требуется определенный почтовый сервер - снимите флажок «Использовать Системные настройки SMTP» и настройте почтовый сервер вручную.

<br/>

Кроме того, этот узел может создавать **вложения** для электронных писем, если входящее сообщение имеет подготовленное поле вложений со ссылкой на файлы, хранящиеся в базе данных.

<br/>

В случае успешной отправки письма по почте исходное сообщение будет передано следующим узлам по цепочке **Success**, в противном случае используется цепочка **Failure**

В следующем уроке вы можете увидеть пример, где используется этот узел:

- [Send Email](/docs/user-guide/rule-engine-2-0/tutorials/send-email/)

<br/>
