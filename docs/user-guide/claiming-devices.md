---
layout: docwithnav
title: Подтверждение устройств
description: Подтверждение устройств

---

* TOC
{:toc}

## Когда это необходимо

Как тенант, вы хотели бы предварительно подготовить к подключению к платформе свои устройства с помощью скрипта или пользовательского интерфейса (UI). Ваши клиенты покупают устройства непосредственно у вас или через дистрибьюторов. Вы хотели бы, чтобы ваши клиенты подтверждали свои устройства по QR-коду или схожим способом, как только они получат физический доступ к устройству.

Как только устройство подтверждено, клиент становится его владельцем, а пользователи клиента могут получить доступ к данным устройства и управлять им.

## Сценарии подтверждения устройств
 
Пользователь платформы может подтвердить устройство, если он знает его имя и секретный ключ. Секретный ключ является опциональным, всегда имеет срок действия и может изменяться с течением времени.
Секретный ключ может быть подготовлен двумя различными способами. Либо сообщается устройством (device-side ключ), либо используется атрибут устройства на стороне сервера (server-side ключ). Более подробную информацию смотрите ниже.

### Подтверждение при помощи Device-side ключа

Эта процедура требует, чтобы устройство сгенерировало секретный ключ на основе некоторого триггерного события. Например, после загрузки устройства или при нажатии какой-либо физической кнопки. Как только секретный ключ сгенерирован, он действителен в течение определенного периода времени. Устройство передает информацию о секретном ключе и сроке его действия на сервер платформы.
Платформа хранит информацию о подтверждении в течение всего срока действия ключа. Смотрите диаграмму ниже.

![image](/images/user-guide/claiming-devices/device-side-key-diagram.png)

Устройство может передавать информацию о подтверждении платформе, используя все поддерживаемые транспортные протоколы. Тело сообщения имеет два параметра: **secretKey** и **durationMs**, которые могут быть заданы дополнительно. 
Параметр **secretKey** обеспечивает безопасность процесса подтверждения. 
Параметр **durationMs** определяет истечение времени подтверждения. 
Если **secretKey** не указан, то в качестве значения по умолчанию используется пустая строка. 
В случае, если **durationMs** не указан, используется системный параметр device.claim.duration

Пожалуйста, ознакомьтесь с Device API, чтобы получить информацию о структуре сообщений в которых можно передавать сообщения о подтверждении. Вы можете использовать MQTT Gateway API, который также позволяет инициировать подтверждение нескольких устройств за один раз.

 - [MQTT Device API](/docs/reference/mqtt-api/#claiming-devices)
 - [CoAP Device API](/docs/reference/coap-api/#claiming-devices)
 - [HTTP Device API](/docs/reference/http-api/#claiming-devices)
 - [MQTT Gateway API](/docs/reference/gateway-mqtt-api/#claiming-devices-api)
 

После передачи информации о подтверждении, устройство может отображать секретный ключ либо в виде обычного текста, либо в виде QR-кода. Пользователь должен отсканировать этот ключ и использовать его для передачи запроса на подтверждение. Запрос состоит из имени устройства и секретного ключа. В качестве имени устройства можно использовать MAC-адрес или другое уникальное свойство. Смотрите инструкции по передаче заявки здесь [здесь](/docs/user-guide/claiming-devices/#device-claiming-api-request).   

**Примечание** секретный ключ также может быть пустой строкой. Это может быть необходимо, если ваше устройство никаким способом не может отобразить секретный ключ. Например, вы можете разрешить подтверждение устройства в течение 30 секунд после нажатия соответствующей кнопки. В этом случае пользователю необходимо знать только имя устройства (MAC-адрес и т. д.).

Сервер проверяет запрос и отвечает на него. Ответ содержит статус операции подтверждения и идентификатор устройства, если операция была успешной.
После запроса пользователь-клиент может использовать виджет подтверждения устройства       

### Подтверждение с помощью Server-side ключа

Предположим, что есть тысячи устройств NB IoT/LoRaWAN/Sigfox, подключенных с помощью одной из интеграций платформы. Интеграционный слой автоматически подключит их к платформе. Предполагая, что тенант-админ знает список DevEUIs для LoRaWAN или иные идентификаторы устройств, можно сгенерировать случайный секретный ключ для каждого устройства и загрузить этот ключ на платформу в качестве server-side атрибута с помощью REST API или пользовательского интерфейса. Как только это будет сделано, тенант админ может отправить эти ключи клиенту по электронной почте или поместить их в коробку с устройством. 

![image](/images/user-guide/claiming-devices/server-side-key-diagram.png)

Чтобы предоставить секретный ключ устройства, тенант админ должен установить server-side атрибут “claimingData” со следующим значением:

```json
{"secretKey": "YOUR_SECRET_KEY", "expirationTime": "1640995200000"}
``` 

где 1577836800000 – это время истечения срока действия секретного ключа устройства, которое равно 01/01/2022 в виде временной метки unix с точностью до миллисекунд.
После подготовки server-side атрибута пользователь может использовать виджет подтверждения устройства.

## Разрешения на подтверждение устройства

Важно, что пользователь, который пытается подтвердить устройство, должен иметь для этого необходимые полномочия. В данном случае необходимыми полномочиями являются:

- **Resource: Device**
- **Operation: Claim devices**

Чтобы добавить пользователю полномочия, необходимо сделать следующее:
Во-первых, нам нужно создать универсальную роль:

![image](/images/user-guide/claiming-devices/claiming-generic-role.png)

А затем назначить эту роль группе:

![image](/images/user-guide/claiming-devices/assign-claiming-role.png)

## Виджет подтверждения устройства

Виджет подключения устройства довольно прост, в нем вводится имя устройства и секретный ключ.

![image](/images/user-guide/claiming-devices/claim-device-widget.png)

Можно скрыть поле ввода секретного ключа и изменить метки в разделе “Общие настройки”.

![image](/images/user-guide/claiming-devices/claim-device-widget-advanced-settings.png)

Также можно настроить все виды сообщений, отправляемых пользователю, в разделе “Настройки сообщений”.

![image](/images/user-guide/claiming-devices/claim-device-widget-message-settings.png)

Наконец, вы можете связать подтвержденное устройство с текущим состоянием сущности дашборда. Это полезно, если у вас есть несколько объектов и вы хотите связать устройство с одним из них. 

![image](/images/user-guide/claiming-devices/claim-device-widget-relation-settings.png)

## API-запрос подтверждения устройства

Запрос подтверждения отправляется в виде:

```shell
http(s)://host:port/api/customer/device/$DEVICE_NAME/claim
```
Поддерживаемый формат данных:

```json
{"secretKey":"value"}
```

**Примечание:** сообщение не содержит параметра **duarationMs**, а параметр **secretKey** является опциональным.

Whenever claiming is succeed the device is being assigned to the specific customer. The **claimingAllowed** attribute is automatically deleted in case the system parameter **allowClaimingByDefault** is **false**.

Всякий раз, когда подтверждение проходит успешно, устройство назначается конкретному клиенту. Атрибут **claimingAllowed** автоматически удаляется в случае, если системный параметр **allowClaimingByDefault** имеет значение **false**. 

См. ниже для получения более подробной информации о вышеуказанных шагах.

## API отмены подтверждения устройства

Чтобы отменить подтверждение устройства, вы можете отправить DELETE-запрос по следующему URL-адресу:

```shell
http(s)://host:port/api/customer/device/$DEVICE_NAME/claim
```
