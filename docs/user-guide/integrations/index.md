---
layout: docwithnav
title: Интеграция платформы
description: Интеграция платформы 
---

* TOC
{:toc}

### Обзор

Функция интеграции IoT платформы Ростелеком была разработана для двух основных вариантов использования / развертывания:

- Подключения существующих устройств NB IoT, LoRaWAN, SigFox и других устройств с определенными форматами полезной нагрузки непосредственно к платформе.
- Потоковой передачи данных с устройств, подключенных к существующим IoT-платформам, чтобы предоставить обновляющиеся в режиме реального времени интерактивные дашборды, а также эффективную обработку данных.
Оба варианта использования имеют кое-что общее. В топологии развертывания есть серверный компонент, который предотвращает прямой доступ к устройству и предоставляет набор API для взаимодействия с устройством в полевых условиях. Формат полезной нагрузки устройства четко не определен. Часто два устройства, имеющие одинаковые датчики, имеют разные форматы полезной нагрузки в зависимости от поставщика или даже от версии ПО.

Задача интеграции платформы состоит в том, чтобы обеспечить безопасный и надежный API-мост между основными функциями платформы (сбор телеметрии, атрибуты и RPC-вызовы) и конкретными API-интерфейсами сторонних приложений.    

### Как это работает?

На данный момент платформа поддерживает различные интеграционные протоколы. Наиболее популярные: HTTP, MQTT и OPC-UA. Также платформа поддерживает интеграцию с определенным серверам LoRaWAN Network, Sigfox backend, различными устройствами NB IoT с помощью RAW UDP и TCP интеграции. Возможности интеграции с другими платформами позволяют подписаться на канал данных от устройства через MQTT или AMQP.

Как только сообщение поступает из внешней платформы в IoT платформу Ростелеком, оно проходит проверку в соответствии с форматом полезной нагрузки платформы и правилами безопасности. После проверки сообщения интеграция платформы вызывает преобразователь uplink-данных для извлечения значимой информации из входящего сообщения. Сообщение в основном преобразуется из полезной нагрузки, специфичной для устройства и платформы, в формат, используемый платформой.

Частые случаи использования:
- изменение частоты загрузки данных с помощью изменения значения общего атрибута
- запуск процедуры обновления прошивки с помощью изменения значения общего атрибута
- изменение состояния устройства с помощью RPC-вызова;

Как только сообщение посылается механизмом правил, платформа вызывает преобразователь downlink-данных и преобразовывает сообщение в определенный формат, используемый интеграцией.

<br/>

<object width="80%" data="/images/user-guide/integrations/integrations-overview.jpg"></object>
 
 
### Варианты развертывания
 
Интеграция IoT платформы Ростелеком имеет два варианта развертывания: встроенный и удаленный. Подробные сведения и архитектурные схемы показаны ниже.

#### Встроенные интеграции
Встроенная интеграция выполняется в основном процессе сервера платформы. В основном это часть сценария монолитного деплоя.

Плюсы:
- упрощает развертывание новой интеграции (всего несколько кликов в пользовательском интерфейсе платформы)
- минимальная задержка доставки сообщения

Минусы:
- потребление ресурсов, выделяемых на основные процессы платформы: сетевые подключения, потоки ОС и циклы процессора;
- низкий уровень изоляции;
- невозможность получить доступ к локальным брокерам MQTT или серверам OPC-UA, если платформа развернута в облаке.
  
<object width="60%" data="/images/user-guide/integrations/embeded-integrations-overview.svg"></object> 
  
#### Удаленная интеграция
 
Можно установить удаленную интеграцию в локальной сети и передавать данные в облако.
Предположим, что у вас есть локальный брокер MQTT или сервер OPC-UA, развернутый локально. Эти брокеры и серверы не имеют выделенного внешнего IP-адреса, поэтому облачная платформа не может подключиться к ним напрямую. Однако вы можете установить удаленную интеграцию в той же локальной сети, в которой находится сервер. Эта интеграция будет подключаться к брокеру/серверу, извлекать данные и хранить их в локальной файловой системе. Удаленная интеграция будет передавать данные в облачную платформу, когда будет доступно подключение к интернету.

Плюсы:

- реализует интеграцию с серверами, развернутыми в локальной сети;
- изолирует процесс интеграции от основных процессов платформы;

Минусы:

- требуется установка отдельного пакета;
Как настроить интеграцию для удаленного запуска

<object width="70%" data="/images/user-guide/integrations/remote-integrations-overview.svg"></object> 

### Конвертеры данных

Это часть функции интеграции платформы. Существуют восходящие и нисходящие преобразователи данных.
 
#### Uplink конвертер данных

Основная функция данного конвертора заключается в анализе полезной нагрузки входящего сообщения и в преобразовании его в формат, используемый платформой.
Это пользовательская функция:

```javascript
function Decoder(payload, metadata);
```

##### Полезная нагрузка

Это данные, сохраняющиеся в форматах: JSON, TEXT, Binary(Base64). Специфичны для вашего типа интеграции.
В шаблоне восходящего конвертора содержатся вспомогательные функции для преобразования входящей полезной нагрузки:

```javascript
function decodeToString(payload) {
   return String.fromCharCode.apply(String, payload);
}

function decodeToJson(payload) {
   // covert payload to string.
   var str = decodeToString(payload);
   // parse string to JSON
   return JSON.parse(str);
}
```

Существуют также функции btoa и atob, доступные для декодирования полезной нагрузки, хранящейся в двоичном формате (Base64).  

##### Метаданные

Это карта, хранящаяся в формате «ключ-значение», с некоторыми полями, специфичными для интеграции. Дополнительные метаданные для каждой интеграции можно настроить в разделе «Сведения об интеграции». Например, вы можете указать тип устройства в качестве дополнительного параметра метаданных интеграции и использовать его для автоматического назначения соответствующего типа новым устройствам

##### Результаты конвертации
 
Результаты конвертации должны сохраняться документом в формате JSON со следующей структурой:

```json
{
    "deviceName": "Device A",
    "deviceType": "thermostat",
    "customerName": "Company Name",
    "groupName": "Thermostats",
    "attributes": {
        "model": "Model A",
        "serialNumber": "SN-111",
        "integrationName": "Test integration"
    },
    "telemetry": {
        "temperature": 42,
        "humidity": 80
    }
}
```

**Примечание**:единственными обязательными параметрами в данном JSON являются deviceName и deviceType, платформа также поддерживает assetName и assetType вместо deviceName и deviceType.

**Примечание**: платформа также поддерживает необязательные параметры customerName и groupName. Они используются для автоматического создания группы клиентов и сущностей и назначения этих сущностей клиенту и группе.

Конвертер может также выводить массив значений устройств и содержать временные метки в телеметрических значениях. Например:

```json
[
    {
        "deviceName":"SN-111",
        "deviceType":"thermostat",
        "attributes":{
            "model":"Model A"
        },
        "telemetry":[
            {
                "ts":1527863043000,
                "values":{
                    "battery":3.99,
                    "temperature":27.05
                }
            },
            {
                "ts":1527863044000,
                "values":{
                    "battery":3.98,
                    "temperature":27.06
                }
            }
        ]
    },
    {
        "assetName":"OF-123",
        "assetType":"office",
        "attributes":{
            "model":"Model A"
        },
        "telemetry":{
            "ts":1527863041000,
            "values":{
                "battery":3.99,
                "temperature":27.05
            }
        }
    }
]
```
 
##### Пример

Рассмотрим сложный пример, где полезная нагрузка кодируется в шестнадцатеричном поле “Значение” и каждой записи присваивается временная метка. Первые два байта поля содержат показания аккумулятора, а вторые два – показания температуры. Пример полезной нагрузки и метаданных:

![image](/images/user-guide/integrations/uplink-converter-example.png) 

Полный исходный код функции javascript, используемой в конвертере, доступен здесь [ссылка](/docs/user-guide/resources/uplink-data-converter-example.js).

В видео-инструкции ниже показано, как запустить восходящий конвертор данных

<br/>
<div id="video">  
    <div id="video_wrapper">
        <iframe src="https://www.youtube.com/embed/CojStpYCTGI" frameborder="0" allowfullscreen></iframe>
    </div>
</div> 

#### Downlink дата конвертер
 
Основная функция данного конвертора заключается в преобразовании входящего сообщения движка правил и его метаданных в формат, используемый соответствующей интеграцией.

Это пользовательская функция:

```javascript
function Decoder(msg, metadata, msgType, integrationMetadata);
```

В которой

 - **msg** - JSON с msg движка правил
 - **metadata** - список пар «ключ-значение» с дополнительными данными о сообщении (создается движком правил)
 - **msgType** - тип сообщения движка правил. Подробнее в разделе [Предопределенные типы сообщений](/docs/user-guide/rule-engine-2-0/overview/#predefined-message-types).
 - **integrationMetadata** - карта в формате «ключ-значение» с некоторыми специфичными для интеграции полями. Дополнительные метаданные для каждой интеграции можно настроить в разделе Сведения об интеграции..
  
##### Результаты конвертации

Должны сохраняться в формате JSON-документа:

```json
{
    "contentType": "JSON",
    "data": "{\"tempFreq\":60,\"firmwareVersion\":\"1.2.3\"}",
    "metadata": {
        "topic": "temp-sensor/sensorA/upload"
    }
}
```

где

 - **contentType** - значение JSON, TEXT или BINARY (Base64 string). Оно специфично для вашего типа интеграции.
 - **data** - строка данных по типу контента.
 - **metadata** - список пар «ключ-значение» с дополнительными данными о сообщении. Например, тема для использования для интеграции MQTT и т. д.

##### Пример

Рассмотрим пример, когда атрибуты, отвечающие за частоту загрузки показателей температуры и влажности, обновляются через REST API платформы. И, предположим, вы хотите отправить эти обновленные данные внешнему брокеру MQTT (TTN, Mosquitto, AWS IoT и т.д.). 
Вы также можете включить значение атрибута “firmwareVersion”, который был ранее настроен и сейчас отсутствует в этом конкретном запросе. 
Тема для отправки обновления должна содержать имя устройства.

![image](/images/user-guide/integrations/downlink-converter-example.png) 


Полный исходный код функции javascript, используемой в конвертере, доступен [**здесь**](/docs/user-guide/resources/downlink-data-converter-example.js). 

Чтобы вызвать нисходящую обработку интеграцией, тенант-администратор должен настроить цепочку правил таким образом:

![image](/images/user-guide/integrations/downlink-rule-chain-example.png)

Полная настройка цепочки правил доступна [**здесь**](/docs/user-guide/resources/downlink_example_rule_chain.json).

##### Синхронный и асинхронный Downlinks 

Большинство интеграций способны обрабатывать нисходящие сообщения на устройства асинхронно. Например, каждое сообщение, передаваемое движдком правил для интеграции на основе MQTT, немедленно передается соответствующему внешнему брокеру MQTT.
Однако некоторые интеграции, такие как SigFox или generic HTTP, не могут передавать сообщения асинхронно. Эти интеграции, из-за особенностей базового протокола HTTP, способны только синхронно передавать информацию по нисходящей линии связи в ответ на запрос сообщения по восходящей линии связи. В этом случае последнее сообщение по нисходящей линии связи, созданное движком правил, будет храниться в очереди до тех пор, пока новое сообщение по восходящей линии не будет получено устройством.

### Режим отладки

Эта функция позволяет сохранять:

- входящие сообщения от сторонней системы;
- значения метаданных;
- результаты преобразования данных;
- результаты обработки полезной нагрузки.
Режим позволяет быстро разрабатывать конверторы и конфигурировать интеграционные системы. Также с помощью него можно проверять настройки конфигурации, и данный режим следует использовать только для отладки, так как она значительно влияет на производительность.


### Интеграция платформы и IoT-шлюз

Продвинутые пользователи платформы могут заметить, что функционал Интеграций частично пересекается с функционалом [IoT-шлюза](/docs/iot-gateway/what-is-iot-gateway/).
Однако существуют определенные различия между этими двумя системами:

- IoT-шлюз предназначен для деплоя локальной сети, интеграции - для межсерверной интеграции.
- IoT-шлюз предназначен для поддержки < 1000 устройств, в то время как для интеграции предусмотрена высокая пропускная способность, масштабируемость и деплой кластеров в составе сервера платформы.
- Перекомпиляция шлюза и перезапуск требуются для добавления пользовательского декодера полезной нагрузки. В то время как интеграционный конвертер - это функция JS, которая может быть изменена в режиме реального времени. 

Обе системы по-своему важны и применимы в разных ситуациях.


### Функция «Дорожная карта»

#### Статистика использования
 
Мы планируем собирать статистику по количеству сообщений, обработанных каждой интеграцией, с возможными ограничениями на сообщения, обработанные на уровне клиента / системы.

#### More integrations and protocols

Мы планируем обеспечить специальные интеграции для различных платформ, а также для различных коммуникационных протоколов, таких как gRPC.

#### Больше конверторов данных

Мы планируем собирать и обслуживать конверторы данных для самых популярных устройств на рынке, чтобы еще больше упростить путь интеграции. 
Вы можете поделиться своими конвертерами с сообществом и отправить их нам, чтобы сделать их частью официального дистрибутива IoT платформы Ростелеком.
Свяжитесь с нами, чтобы предложить недостающую.
   
### See Also

Руководства и видеоуроки, связанные с конкретными интеграциями:

 - [HTTP](/docs/user-guide/integrations/http/)
 - [MQTT](/docs/user-guide/integrations/mqtt/)
 - [AWS IoT](/docs/user-guide/integrations/aws-iot/)
 - [AWS Kinesis](/docs/user-guide/integrations/aws-kinesis/)
 - [IBM Watson IoT](/docs/user-guide/integrations/ibm-watson-iot/)
 - [Azure Event Hub](/docs/user-guide/integrations/azure-event-hub/)
 - [Azure IoT Hub](/docs/user-guide/integrations/azure-iot-hub/)
 - [Actility ThingPark](/docs/user-guide/integrations/thingpark/)
 - [SigFox](/docs/user-guide/integrations/sigfox/)
 - [OceanConnect](/docs/user-guide/integrations/ocean-connect/)
 - [TheThingsNetwork](/docs/user-guide/integrations/ttn/)
 - [OPC-UA](/docs/user-guide/integrations/opc-ua/)
 - [TCP](/docs/user-guide/integrations/tcp/)
 - [UDP](/docs/user-guide/integrations/udp/)
 - [Kafka](/docs/user-guide/integrations/kafka/)
 - [Custom](/docs/user-guide/integrations/custom/)
