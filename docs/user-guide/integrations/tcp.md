---
layout: docwithnav
title: TCP интеграция
---

* TOC
{:toc}

## Обзор

TCP интеграция позволят получать данные с устройств, которые используют транспортный протокол TCP, а также позволяет конвертировать полезную нагрузку данных устройств в формат, поддерживаемый платформой.


**Внимание** TCP интеграция может быть запущена только как [Удаленная интеграция](/docs/user-guide/integrations/remote-integrations).
Для получения большей информации изучите диаграмму интеграции.

![image](/images/user-guide/integrations/tcp-integration.png)

## Настройка TCP интеграции

### Предусловия

В данном руководстве мы воспользуемся:

 - TCP интеграцией, которая запущена удалённо и подключена к облачной версии платформы;
 - командой **echo**, которая предназначена для отображения строки текста и перенапраправления результатов в утилиту **netcat** (**nc**);
 - утилитой **netcat** (**nc**) для установки UDP-связей, получения и преобразования данных;    

Предположим, что у нас есть датчик, который посылает текущие показания температуры и влажности.
Наш датчик **SN-001** публикует температуру и показатели влажности в TCP интеграцию по порту **10560** в машину, где данная интеграция запущена.

Для наглядного примера предположим, что наше устройство достаточно умное для отправки данных в трёх разных форматах полезной нагрузки:
 - **Text** - в этом случае полезная нагрузка выглядит так - **SN-001,default,temperature,25.7\n\rSN-001,default,humidity,69**
 - **JSON** - в этом случае полезная нагрузка выглядит так
 
```json
[
  {
    "deviceName": "SN-001",
    "deviceType": "default",
    "temperature": 25.7,
    "humidity": 69
  }
]
```
 - **Двоичный формат** - **\x30\x30\x30\x30\x11\x53\x4e\x2d\x30\x30\x31\x64\x65\x66\x61\x75\x6c\x74\x32\x35\x2e\x37\x00\x00\x00** (шестнадцатиричная строка). 
 Описание байтов в этой полезной нагрузке:
    - **0-3** байт - **\x30\x30\x30\x30** - ненастоящие байты, чтобы показать, как вы можете пропустить определенные префиксные байты в вашей полезной нагрузке. Эти байты включены в качестве примера;
    - **4** байт - **\x11** - длина полезной нагрузки. Если конвертировать в десятичное число - **17**. Таким образом, наша полезная нагрузка в этом случае ограничена 17 байтами из входящего TCP-фрэйма;
    - **5-10** байт - **\x53\x4e\x2d\x30\x30\x31** - имя устройства. Если конвертировать в текстовый формат - **SN-001**;
    - **11-17** байт - **\x64\x65\x66\x61\x75\x6c\x74** - тип устройства. IЕсли конвертировать в текстовый формат - **default**;
    - **18-21** байт - **\x32\x35\x2e\x37** - телеметрия температуры. Если конвертировать в текстовый формат - **25.7**;
    - **22-24** байт - **\x00\x00\x00** - ложный байты. Мы их игнорируем, так как размер полезной нагрузки равен **17** байтам - от **5** до **21**. Этот диапазон доступен в качестве примера.
    
Вы можете выбрать тип полезной нагрузки в зависимости от возможностей вашего устройства и бизнес-кейсов.
 
 **Внимание:** порт **10560**, который используется на машине, в которой запущена TCP интеграция, должен быть открыт для входящих связей - должно быть возможным подключить утилиту **nc** к UDP сокету.
Если вы запускаете интеграцию локально, она должна успешно работать без каких-либо дополнительных изменений.

### Конвертер данных от устройства

Перед тем, как запускать **TCP интеграцию**, нужно создать **Конвертер от устройства**: скрипт для парсинга и преобразования данных, получаемых через TCP интеграцию.

Чтобы создать конвертер, перейдите в раздел **Конвертеры данных** и нажмите **Добавить новый конвертер данных —> Создать новый конвертер**.
Назовите его как **"TCP Uplink Converter"** и выберите тип **Uplink**. Включите режим отладки.

**Примечание**: режим отладки необходим для процесса разработки и устранения неисправностей, однако, оставляя данный режим включенным, вы рискуете значительно увеличить дисковое пространство, используемое базой данных. Так как все данные, полученные в данном режиме, записываются на этот диск. Поэтому настоятельно рекомендуем выключать режим сразу по завершении процесса отладки.

Выберете формат данных полезной нагрузки сообщения для настройки декодера

{% capture uplinkpayload %}
Text payload<br/>%,%text%,%templates/integration/tcp/tcp-uplink-converter-text.md%br%
JSON payload<br/>%,%json%,%templates/integration/tcp/tcp-uplink-converter-json.md%br%
Binary payload<br/>%,%binary%,%templates/integration/tcp/tcp-uplink-converter-binary.md{% endcapture %}

{% include content-toggle.html content-toggle-id="tcpintegartionuplinkpayload" toggle-spec=uplinkpayload %}

#### Конвертер данных к устройству

**На данный момент TCP интеграция не поддерживает данный функционал**

### Установка TCP интеграции

Перейдите в раздел **Интеграции** и нажмите кнопку **Добавить новую интеграцию**. Назовите ее **TCP Integration**, выберете тип **TCP**, включите режим отладки и в раскрывающемся меню добавьте недавно созданный конвертер данных от устройства.

Функция **Выполнять удаленно** включена и не может быть изменена - TCP интеграция может быть только под типом**remote**.

Запишите **Ключ интеграции** и **Секрет интеграции** - эти значения понадобятся в дальнейшем для настройки удаленной TCP интеграции.

![image](/images/user-guide/integrations/tcp/tcp-integration-setup.png)

По умолчанию TCP интеграция будет использовать порт **10560**, но вы можете поменять его на любой доступный порт. 

Остальные настройки мы оставляем по умолчанию. Короткое описание данных настроек:
- **Максимальное количество отложенных подключений на сокете** - Максимальная длина очереди для входящих сигналов подключения (запрос на подключение), устанавливается в параметре backlog. Если индикатор соединения поступает, когда очередь достигла максимальной длины, соединение отключается;
- **Размер буфера для входящего сокета** - размер в KBytes буфера приема данных сокета;
- **Размер буфера для исходящего сокета** - размер в KBytes буфера отправки данных сокета;
- **Включить отправку сообщений keep-alive на сокетах, ориентированных на соединение** - флаг, указывающий, что датчики должны периодически отправляться по сети в противоположный сокет, чтобы сохранить соединение активным;
- **Заставляет сокет отправлять данные без буферизации (отключить алгоритм буферизации Нейгла)** - отключает алгоритм Нейгла на сокете, который задерживает передачу данных до тех пор, пока не накопится определенный объем отложенных данных.

Выберете тип данных полезной нагрузки сообщения для **Настройки обработчика**

{% capture handlerconfiguration %}
Текстовый<br/>%,%text%,%templates/integration/tcp/tcp-handler-configuration-text.md%br%
JSON<br/>%,%json%,%templates/integration/tcp/tcp-handler-configuration-json.md%br%
Двоичный<br/>%,%binary%,%templates/integration/tcp/tcp-handler-configuration-binary.md{% endcapture %}

{% include content-toggle.html content-toggle-id="tcpintegrationhandlerconfiguration" toggle-spec=handlerconfiguration %}

Нажмите **Добавить** для сохранения интеграции.

#### Установка и запуск внешней TCP интеграции

В руководстве [Удаленная интеграция](/docs/user-guide/integrations/remote-integrations) можно найти необходимую информацию для установки сервиса UPD интеграции локально или на отдельной машине.

Используйте **Ключ интеграции** и **Секрет интеграции** из раздела выше для настройки вашей TCP интеграции.  

### Отправка сообщения от устройства

Когда создается TCP интеграция, запускается TCP сервер. И затем он ожидает получения данных с устройств.

Выберите тип данных полезной нагрузки для сообщений от устройства

{% capture senduplink %}
Текстовый<br/>%,%text%,%templates/integration/tcp/tcp-send-uplink-text.md%br%
JSON<br/>%,%json%,%templates/integration/tcp/tcp-send-uplink-json.md%br%
Двоичный<br/>%,%binary%,%templates/integration/tcp/tcp-send-uplink-binary.md{% endcapture %}

{% include content-toggle.html content-toggle-id="tcpintegrationsenduplink" toggle-spec=senduplink %}

Перейдя в **Группы устройств -> All**, вам нужно найти устройство **SN-001**, которое  работает с интеграцией.
Нажмите на устройство, перейдите в **Последнюю телеметрию**. Там вы увидите ключ "temperature" и его значение (25.7).

Если полезная нагрузка содержит телеметрию **humidity** telemetry, вы сможете увидеть ключ "humidity" и его значение (69).
